const TelegramBot = require('node-telegram-bot-api');
const moment = require('moment-timezone');
const fs = require('fs');
const path = require('path');

const turkishDateTime = moment().tz('Europe/Istanbul').format('YYYY-MM-DD HH:mm:ss');

const blockedUsernames = ['thionte'];

const logFile = fs.createWriteStream('./log.txt', { flags: 'a' });

// Botunuz iÃ§in bir token alÄ±n ve buraya yazÄ±n
const TOKEN = '5780649490:AAFJtT3hlmn_KiAS07FO2g81MP3OeHpzULg';

// Botunuzu oluÅŸturun ve baÅŸlatÄ±n
const bot = new TelegramBot(TOKEN, {polling: true});

let merhaba = false;
bot.on('message', (msg) => {
    if (merhaba) {
    return;
  }
  merhaba = true;
  const chatId = msg.chat.id;
  const username = msg.from.username;

    // Kontrol etmek istediÄŸiniz kullanÄ±cÄ± adlarÄ±nÄ± bir diziye ekleyin
  if (blockedUsernames.includes(username)) {
     bot.sendMessage(chatId, `Bot Ã¼zerinden kalÄ±cÄ± olarak siktir Ã§ekildiniz. Orospu Ã§ocukluÄŸunuzu baÅŸka yerlerde sergilemeniz dileÄŸiyle. Bye Bye...`);
    // EÄŸer kullanÄ±cÄ± adÄ± bir yasaklÄ± kullanÄ±cÄ± adÄ± ise, yanÄ±t vermeyin
    return;
  }
  

bot.onText(/\/dosyalar/, (msg) => {
  bot.sendMessage(msg.chat.id, 'LÃ¼tfen indirmek istediÄŸiniz dosyalarÄ±n hangi klasÃ¶rden olacaÄŸÄ±nÄ± seÃ§in:', {
    reply_markup: {
      inline_keyboard: [
        [
          {
            text: 'Denemeler',
            callback_data: 'denemeler'
          },
          {
            text: 'Konu AnlatÄ±m',
            callback_data: 'konuanlatim'
          },
          {
            text: 'Soru BankasÄ±',
            callback_data: 'sorubankasÄ±'
          }
        ]
      ]
    }
  });

  // /dosyalar komutunun sadece bir kez Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± iÃ§in dinleyiciyi kaldÄ±rÄ±n

});

bot.on('callback_query', (query) => {
  const folder = query.data;
  fs.readdir(`./${folder}`, (err, files) => {
    if (err) {
      throw err;
    }

    const pdfFiles = files.filter((file) => file.endsWith('.pdf'));

    let fileList = '';
    pdfFiles.forEach((file, index) => {
      fileList += `${index + 1}. ${file}\n`;
    });
    bot.sendMessage(query.message.chat.id, fileList);

    bot.on('message', (msg) => {
      const fileIndex = msg.text - 1;
      if (fileIndex >= 0 && fileIndex < pdfFiles.length) {
        const filePath = path.join(`./${folder}`, pdfFiles[fileIndex]);
        bot.sendDocument(msg.chat.id, filePath);
        bot.sendMessage(msg.chat.id, 'Dosya numarasÄ± baÅŸarÄ±yla seÃ§ildi. Ä°ndiriliyor...');
        } else {
        bot.sendMessage(msg.chat.id, 'GeÃ§ersiz dosya numarasÄ± seÃ§ildi. LÃ¼tfen tekrar deneyin.');
      }
    });
  });
});
// KullanÄ±cÄ± botu baÅŸlattÄ±ÄŸÄ±nda, botun ne olduÄŸunu yazdÄ±rÄ±n
// Selam verme mesajÄ±nÄ± gÃ¶nder
bot.onText(/\/start/, (msg) => {

  const chatId = msg.chat.id;
  const userName = msg.from.first_name;
  bot.sendMessage(chatId, `Merhaba ${userName} ğŸ‘‹
    
-Sadece 30 MB veya altÄ±ndaki PDF dosyalarÄ±nÄ± alÄ±p sisteme kaydedebilirim. LÃ¼tfen sadece 30 MB veya altÄ±ndaki PDF dosyalarÄ±nÄ± gÃ¶nderin. 

-Kpss dosyasÄ± haricinde bir dosya gÃ¶nderirseniz sistemden kalÄ±cÄ± olarak engellenirsiniz.

-Pdf Boyutunu KÃ¼Ã§Ã¼lt - https://www.ilovepdf.com/tr/pdf-kucultme`);
});
});

// KullanÄ±cÄ±dan bir PDF dosyasÄ± yÃ¼klemesini isteyin
bot.on('document', (msg) => {
  // Dosya bilgilerini alÄ±n
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  const username = msg.from.username;
  const fileId = msg.document.file_id;
  let fileName = msg.document.file_name;

  // KullanÄ±cÄ±dan dosya kaydedilecek klasÃ¶rÃ¼ seÃ§mesini isteyin
  bot.sendMessage(msg.chat.id, 'LÃ¼tfen PDF DosyanÄ±z Hangi Kategorideyse Onu SeÃ§iniz:', {
    reply_markup: {
      inline_keyboard: [
        [
         {
            text: 'Denemeler',
            callback_data: 'denemeler'
          },
          {
            text: 'Konu AnlatÄ±m',
            callback_data: 'konuanlatim'
          },
          {
            text: 'Soru BankasÄ±',
            callback_data: 'sorubankasÄ±'
          }
        ]
      ]
    }
  });

   // '.pdf' uzantÄ±sÄ±nÄ± silin ve '@kpsspdflistesi.pdf' ile deÄŸiÅŸtirin.
  fileName = fileName.replace('.pdf', '');
  fileName = `${fileName} @kpsspdflistesi.pdf`;
  
  // KullanÄ±cÄ±nÄ±n seÃ§imine gÃ¶re dosyayÄ± indirin ve kaydedin
  bot.on('callback_query', (query) => {
    const folder = query.data;
    
  if (msg.document.mime_type === 'application/pdf' && msg.document.file_size < 30 * 1024 * 1024) {
    bot.downloadFile(fileId, './').then((filePath) => {
      fs.rename(filePath, `./${folder}/${fileName}`, (err) => {
        if (err) {
          throw err;
        }
              logFile.write(`[${turkishDateTime}] KullanÄ±cÄ± ID: ${userId} - KullanÄ±cÄ± ADI: ${username} - Dosya adÄ±: ${fileName}\n`);
        bot.sendMessage(chatId, 'Dosya seÃ§tiÄŸiniz klasÃ¶re baÅŸarÄ±yla kaydedildi.');
      });
       });
  } else {
    
    // KullanÄ±cÄ±ya bir hata mesajÄ± gÃ¶nderin
    bot.sendMessage(chatId, 'LÃ¼tfen Sadece PDF YÃ¼kleyin ve Dosya Boyutu Dosya < 30 MB Olsun.');
  }
    });
  });
