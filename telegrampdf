const TelegramBot = require('node-telegram-bot-api');
const fs = require('fs');

const logFile = fs.createWriteStream('./log.txt', { flags: 'a' });

// Telegram API anahtarÄ±nÄ±zÄ± buraya yazÄ±n
const TOKEN = '5780649490:AAF7NB1bmeM62SOOHQGhUX1fIE9nWfrnjW0';

// Botu oluÅŸturun
const bot = new TelegramBot(TOKEN, {polling: true});

bot.on('message', (msg) => {
  const chatId = msg.chat.id;
  const username = msg.from.username;

  // Kontrol etmek istediÄŸiniz kullanÄ±cÄ± adlarÄ±nÄ± bir diziye ekleyin
  const blockedUsernames = ['user1', 'user2'];
  if (blockedUsernames.includes(username)) {
     bot.sendMessage(chatId, `ÃœzgÃ¼nÃ¼m bot Ã¼zerinden kalÄ±cÄ± olarak engellendiniz.`);
    // EÄŸer kullanÄ±cÄ± adÄ± bir yasaklÄ± kullanÄ±cÄ± adÄ± ise, yanÄ±t vermeyin
    return;
  }
  
// DosyalarÄ± sÄ±ralama komutunu iÅŸleme
bot.onText(/\/dosyalar/, (msg) => {
  const chatId = msg.chat.id;

  // "files" klasÃ¶rÃ¼ndeki dosyalarÄ± al
  fs.readdir('./files', (err, files) => {
    if (err) {
      throw err;
    }

    // DosyalarÄ± alfabetik olarak sÄ±rala
    files.sort();

    // SÄ±ralanmÄ±ÅŸ dosyalarÄ±n listesini gÃ¶ster
    bot.sendMessage(chatId, `SÄ±ralanmÄ±ÅŸ dosyalar: ${files.join(', ')}\n\nLÃ¼tfen indirmek istediÄŸiniz dosyanÄ±n numarasÄ±nÄ± girin:`, {
      reply_markup: {
        inline_keyboard: files.map((file, index) => [{
          text: `${index + 1}. ${file}`,
          callback_data: file
        }])
      }
    });
  });
});

// Ä°ndirme talebini iÅŸleme
bot.on('callback_query', (query) => {
  const fileName = query.data;
  const chatId = query.message.chat.id;

  // DosyayÄ± indirin
  bot.sendDocument(chatId, `./files/${fileName}`);
});

// Selam verme mesajÄ±nÄ± gÃ¶nder
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const userName = msg.from.first_name;
    bot.sendMessage(chatId, `Merhaba ${userName} ğŸ‘‹
    
-Sadece 30 MB veya altÄ±ndaki PDF dosyalarÄ±nÄ± alÄ±p sisteme kaydedebilirim. LÃ¼tfen sadece 30 MB veya altÄ±ndaki PDF dosyalarÄ±nÄ± gÃ¶nderin. 

-Kpss dosyasÄ± haricinde bir dosya gÃ¶nderirseniz sistemden kalÄ±cÄ± olarak engellenirsiniz.`);
});

// Gelen dosyalarÄ± iÅŸleme
bot.on('document', (msg) => {
   const chatId = msg.chat.id;
  const userId = msg.from.id;
  const username = msg.from.username;
  const fileId = msg.document.file_id;
  const fileName = msg.document.file_name;
  const currentDate = new Date();

  // Dosya PDF dosyasÄ± mÄ± ve dosya adÄ± "KPSS" ibaresi iÃ§eriyor mu?
   // Check if the file is a PDF and is less than 20 MB
  if (msg.document.mime_type === 'application/pdf' && msg.document.file_size < 30 * 1024 * 1024) {
    // PDF dosyasÄ±nÄ± indirin
    bot.downloadFile(fileId, './').then((path) => {
      // DosyayÄ± "files" klasÃ¶rÃ¼ne taÅŸÄ±yÄ±n
      fs.rename(path, './files/' + fileName, (err) => {
        if (err) {
          throw err;
        }
        
 // Txt dosyasÄ±na kaydet
    logFile.write(`[${currentDate}] KullanÄ±cÄ± ID: ${userId} - KullanÄ±cÄ± ADI: ${username} - Dosya adÄ±: ${fileName}\n`);
        
        // KullanÄ±cÄ±ya bir mesaj gÃ¶nderin
        bot.sendMessage(chatId, 'PDF dosyasÄ± baÅŸarÄ±yla kaydedildi.');
      });
    });
  } else {
    // KullanÄ±cÄ±ya bir hata mesajÄ± gÃ¶nderin
    bot.sendMessage(chatId, 'LÃ¼tfen 30 MB ve altÄ±ndaki PDF DosyasÄ±nÄ± yÃ¼kleyin.');
  }
});
  });
